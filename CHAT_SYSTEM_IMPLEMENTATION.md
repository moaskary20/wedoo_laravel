# نظام المحادثات - Chat System

## نظرة عامة
تم إنشاء نظام محادثات شامل في الـ admin panel لعرض وإدارة المحادثات بين العملاء والصانعين.

## المكونات المنشأة

### 1. قاعدة البيانات

#### جدول `chats`
```sql
- id (Primary Key)
- customer_id (Foreign Key to users)
- craftsman_id (Foreign Key to users)
- order_id (Foreign Key to orders, nullable)
- last_message (Text, nullable)
- last_message_at (Timestamp, nullable)
- customer_read (Boolean, default: false)
- craftsman_read (Boolean, default: false)
- status (Enum: active, closed, blocked, default: active)
- created_at, updated_at
- UNIQUE constraint on (customer_id, craftsman_id)
```

#### جدول `chat_messages`
```sql
- id (Primary Key)
- chat_id (Foreign Key to chats)
- sender_id (Foreign Key to users)
- message (Text)
- message_type (String: text, image, file, default: text)
- file_path (String, nullable)
- is_read (Boolean, default: false)
- read_at (Timestamp, nullable)
- created_at, updated_at
- INDEX on (chat_id, created_at)
```

### 2. النماذج (Models)

#### Chat Model
- **العلاقات**:
  - `customer()` - العميل
  - `craftsman()` - الصانعي
  - `order()` - الطلب المرتبط
  - `messages()` - الرسائل
  - `latestMessage()` - آخر رسالة

- **Scopes**:
  - `active()` - المحادثات النشطة
  - `forCustomer($customerId)` - محادثات عميل معين
  - `forCraftsman($craftsmanId)` - محادثات صانعي معين

#### ChatMessage Model
- **العلاقات**:
  - `chat()` - المحادثة
  - `sender()` - المرسل

- **Scopes**:
  - `unread()` - الرسائل غير المقروءة
  - `read()` - الرسائل المقروءة

### 3. Filament Resource

#### ChatResource
- **الموقع**: `app/Filament/Resources/ChatResource.php`
- **الأيقونة**: `heroicon-o-chat-bubble-left-right`
- **التسمية**: "المحادثات"
- **المجموعة**: "التواصل"

#### الميزات:
- **عرض المحادثات** مع معلومات العميل والصانعي
- **فلترة** حسب الحالة، العميل، والصانعي
- **بحث** في أسماء العملاء والصانعين
- **ترتيب** حسب وقت آخر رسالة
- **عرض آخر رسالة** مع tooltip للرسائل الطويلة
- **إدارة الرسائل** من خلال RelationManager

#### MessagesRelationManager
- **عرض جميع الرسائل** في المحادثة
- **فلترة** حسب نوع الرسالة وحالة القراءة
- **إدارة الرسائل** (إنشاء، تعديل، حذف)
- **عرض تفاصيل المرسل** ووقت الإرسال

### 4. الصفحات (Pages)

#### الصفحات المتاحة:
1. **قائمة المحادثات** (`/admin/chats`)
2. **إنشاء محادثة جديدة** (`/admin/chats/create`)
3. **عرض محادثة** (`/admin/chats/{id}`)
4. **تعديل محادثة** (`/admin/chats/{id}/edit`)

## كيفية الاستخدام

### 1. الوصول للمحادثات
- انتقل إلى الـ admin panel
- في القائمة الجانبية، اضغط على "المحادثات" تحت مجموعة "التواصل"

### 2. عرض المحادثات
- ستظهر قائمة بجميع المحادثات
- يمكنك رؤية:
  - اسم العميل والصانعي
  - آخر رسالة
  - وقت آخر رسالة
  - حالة القراءة
  - حالة المحادثة

### 3. إدارة المحادثات
- **عرض محادثة**: اضغط على "عرض" لرؤية تفاصيل المحادثة
- **تعديل محادثة**: اضغط على "تعديل" لتعديل إعدادات المحادثة
- **إدارة الرسائل**: من صفحة عرض المحادثة، يمكنك إدارة الرسائل

### 4. الفلترة والبحث
- **فلترة حسب الحالة**: نشط، مغلق، محظور
- **فلترة حسب العميل**: اختر عميل معين
- **فلترة حسب الصانعي**: اختر صانعي معين
- **البحث**: ابحث في أسماء العملاء والصانعين

## الميزات المتقدمة

### 1. تتبع حالة القراءة
- **customer_read**: هل قرأ العميل آخر رسالة؟
- **craftsman_read**: هل قرأ الصانعي آخر رسالة؟
- **is_read**: هل تم قراءة رسالة معينة؟

### 2. أنواع الرسائل
- **نص**: رسائل نصية عادية
- **صورة**: رسائل تحتوي على صور
- **ملف**: رسائل تحتوي على ملفات

### 3. حالات المحادثة
- **نشط**: المحادثة مفتوحة ويمكن إرسال رسائل
- **مغلق**: المحادثة مغلقة ولا يمكن إرسال رسائل
- **محظور**: المحادثة محظورة

### 4. الربط بالطلبات
- يمكن ربط المحادثة بطلب معين
- هذا يساعد في تتبع المحادثات المتعلقة بطلبات محددة

## API Integration

النظام متوافق مع API المحادثات الموجودة:
- `GET /api/chat/list` - قائمة المحادثات
- `POST /api/chat/send` - إرسال رسالة

## الأمان

- **الصلاحيات**: يمكن تخصيص صلاحيات الوصول للمحادثات
- **التحقق**: جميع البيانات يتم التحقق منها قبل الحفظ
- **العلاقات**: استخدام Foreign Keys لضمان سلامة البيانات

## التطوير المستقبلي

### ميزات يمكن إضافتها:
1. **الإشعارات**: إشعارات عند وصول رسائل جديدة
2. **البحث المتقدم**: بحث في محتوى الرسائل
3. **التصدير**: تصدير المحادثات إلى ملفات
4. **الإحصائيات**: إحصائيات المحادثات والرسائل
5. **الردود السريعة**: قوالب رسائل جاهزة

## استكشاف الأخطاء

### مشاكل شائعة:
1. **لا تظهر المحادثات**: تأكد من وجود بيانات في الجداول
2. **خطأ في العلاقات**: تأكد من صحة Foreign Keys
3. **مشاكل في الصلاحيات**: تحقق من إعدادات المستخدم

### الحلول:
1. **تشغيل migrations**: `php artisan migrate`
2. **مسح cache**: `php artisan cache:clear`
3. **إعادة بناء**: `php artisan optimize`
